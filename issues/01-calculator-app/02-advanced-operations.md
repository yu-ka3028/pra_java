# 高度な演算機能の実装

## 目的

基本電卓機能を拡張し、複雑な計算に対応できる高度な演算機能を実装します。メモリ機能、平均計算、連続計算、式解析などを追加して、より実用的な電卓アプリケーションを開発します。

## ゴール

- メモリ機能（M+, M-, MR, MC）が正常に動作する
- 複数メモリ（M1-M5）による柔軟な計算が可能
- 平均計算が効率的に実行できる
- 連続した複雑な計算が正常に動作する
- 式入力による高度な計算が可能
- 付箋スタイル UI による視覚的なメモリ管理

## 事前準備（調査）

### 1. メモリ機能の設計

- [ ] 単一メモリ（M）の実装方法
- [ ] 複数メモリ（M1-M5）の管理方法
- [ ] メモリ操作のユーザーインターフェース
- [ ] メモリ状態の表示方法

### 2. 平均計算の効率化

- [ ] 平均計算の課題分析
- [ ] メモリ機能を活用した解決案
- [ ] バッチ入力方式の検討
- [ ] ハイブリッド方式の設計

### 3. 式解析の実装

- [ ] 構文解析の基本概念
- [ ] 演算子の優先順位処理
- [ ] 括弧対応の実装方法
- [ ] エラーハンドリングの強化

### 4. 付箋スタイル UI の設計

- [ ] 付箋デザインの実装方法
- [ ] リアルタイム更新の実装
- [ ] アニメーション効果の実装
- [ ] 視覚的フィードバックの設計

## 実装のタスク分解

### Phase 1: メモリ機能の実装

- [ ] 単一メモリ機能の実装
  - `memoryAdd()`メソッドの実装（M+）
  - `memorySubtract()`メソッドの実装（M-）
  - `memoryRecall()`メソッドの実装（MR）
  - `memoryClear()`メソッドの実装（MC）
- [ ] 複数メモリ機能の実装
  - M1-M5 の独立したメモリ管理
  - メモリ間の演算機能
  - メモリ状態の表示機能
- [ ] 付箋スタイル UI の実装
  - メモリ作成時の付箋表示
  - メモリ更新時のリアルタイム表示
  - 複数メモリの視覚的管理
  - メモリの削除・編集機能

### Phase 2: 平均計算の効率化実装

- [ ] 課題分析
  - (1+5+8+12)/4 のような計算の手間
  - ユーザーの操作回数の最小化
  - 直感的な操作フローの設計
- [ ] 解決案の実装
  - メモリ機能による数値の蓄積
  - 合計と個数の自動カウント
  - 平均計算のワンタッチ実行
  - 履歴機能による計算過程の可視化

### Phase 3: 連続計算の実装

- [ ] 連続した計算の処理
  - 1+1-5 のような複数演算子の処理
  - 演算子の優先順位の実装
  - 中間結果の保存と表示
- [ ] 式入力方式の実装
  - 完全な式を一度に入力する方式
  - 構文解析と計算順序の実装
  - 括弧対応の実装

### Phase 4: ハイブリッド方式の実装

- [ ] 個別入力 + メモリ機能
  - 個別入力の簡便性を保持
  - メモリ機能で効率化
  - ユーザーが選択可能
- [ ] 式入力 + 段階的表示
  - 式入力の効率性
  - 計算過程の可視化
  - エラー検出の強化

### Phase 5: 付箋スタイル UI の詳細設計

- [ ] 付箋デザインの実装
  - 付箋の見た目（色、サイズ、影）
  - メモリタイトルの表示
  - メモリ値の表示
  - 付箋の重なり表示
- [ ] メモリ操作の UI
  - メモリ作成時の付箋追加
  - メモリ更新時の値変更
  - メモリ削除時の付箋除去
  - メモリ編集時のタイトル変更
- [ ] リアルタイム更新機能
  - メモリ値の即座反映
  - アニメーション効果
  - 視覚的フィードバック
  - エラー状態の表示

### Phase 6: 在庫管理特化機能の実装

- [ ] 統計計算機能の拡張
  - 標準偏差計算（在庫のばらつき分析）
  - 最小値・最大値の計算
  - 中央値計算
  - 在庫予測のための統計分析
- [ ] パーセンテージ計算機能
  - 在庫率の計算
  - 使用率の計算
  - 残量率の計算
  - 増減率の計算
- [ ] 単位変換機能
  - 重量単位の変換（kg, g, mg）
  - 容量単位の変換（L, mL）
  - 個数単位の変換
  - 薬剤濃度の計算

## 動作確認チェックリスト

### メモリ機能テスト

- [ ] 単一メモリ機能
  - M+（メモリ加算）が正常に動作する
  - M-（メモリ減算）が正常に動作する
  - MR（メモリ呼び出し）が正常に動作する
  - MC（メモリクリア）が正常に動作する
- [ ] 複数メモリ機能
  - M1-M5 の独立した操作が可能
  - メモリ間の演算が正常に動作する
  - メモリ状態が適切に表示される
- [ ] 付箋スタイル UI 機能
  - メモリ作成時に付箋が表示される
  - メモリ更新時に値がリアルタイムで更新される
  - 複数メモリが視覚的に管理される
  - メモリの削除・編集が正常に動作する

### 平均計算機能テスト

- [ ] 効率的な平均計算
  - (1+5+8+12)/4 が効率的に計算できる
  - メモリ機能を活用した自動計算
  - バッチ入力による一括計算
- [ ] 統計計算機能
  - 平均値計算が正常に動作する
  - 合計値の自動計算
  - 個数の自動カウント

### 連続計算機能テスト

- [ ] 複数演算子の処理
  - 1+1-5 のような連続計算が正常に動作する
  - 演算子の優先順位が正しく処理される
  - 括弧を含む計算が正常に動作する
- [ ] 式入力機能
  - 完全な式の一度入力が可能
  - 構文解析が正確に動作する
  - エラーメッセージが適切に表示される

### ハイブリッド機能テスト

- [ ] 入力方式の選択
  - 個別入力と式入力の切り替えが可能
  - ユーザーの好みに応じた操作
  - 学習コストの最小化
- [ ] 計算過程の可視化
  - 段階的な計算過程の表示
  - 中間結果の確認機能
  - エラー検出の強化

### 在庫管理特化機能テスト

- [ ] 統計計算機能
  - 標準偏差計算が正常に動作する
  - 最小値・最大値の計算が正常に動作する
  - 中央値計算が正常に動作する
  - 在庫予測の統計分析が可能
- [ ] パーセンテージ計算機能
  - 在庫率の計算が正常に動作する
  - 使用率の計算が正常に動作する
  - 残量率の計算が正常に動作する
  - 増減率の計算が正常に動作する
- [ ] 単位変換機能
  - 重量単位の変換が正常に動作する
  - 容量単位の変換が正常に動作する
  - 個数単位の変換が正常に動作する
  - 薬剤濃度の計算が正常に動作する

## その他備考

### 注意事項

- 薬剤計算では精度が重要なので、必要に応じて`BigDecimal`を使用する
- 家族向けシステムとして、使いやすさを重視する
- メモリ機能は複雑な計算の効率化に活用できる
- 平均計算などの統計機能は実用的な価値が高い

### 設計検討事項

- 個別入力方式 vs 式入力方式の比較検討
- 平均計算などの複雑な計算の効率性
- 将来的なメモリ機能との連携
- フロントエンド UI との整合性

### 平均計算の課題解決案

#### 現在の課題

- (1+5+8+12)/4 の計算で 4 回の操作が必要
- 各段階での手動計算が面倒
- エラーの可能性が高い

#### 解決案の検討

1. **単一メモリ方式**

   - M+で値を蓄積、MR で合計取得
   - 個数は別途カウント
   - シンプルだが限定的

2. **複数メモリ方式**

   - M1: 合計、M2: 個数、M3: 平均
   - 独立した複数メモリで管理
   - より柔軟な計算が可能

3. **履歴メモリ方式**

   - 計算履歴を順次保存
   - 過去の計算結果を参照
   - 複雑な計算に最適

4. **バッチ入力方式**

   - 複数の数値を一度に入力
   - 自動的に合計と平均を計算
   - 視覚的な確認機能

5. **ハイブリッド方式**
   - 個別入力の簡便性を保持
   - 複数メモリ機能で効率化
   - ユーザーが選択可能

### 付箋スタイル UI の設計詳細

#### 付箋の見た目

- **色**: 黄色系の付箋風デザイン
- **サイズ**: コンパクトで見やすいサイズ
- **影**: 立体感のある影効果
- **重なり**: 複数メモリの重なり表示

#### メモリ操作の流れ

1. **メモリ作成**: 新しい付箋が電卓上部に追加
2. **メモリ更新**: 付箋内の値がリアルタイムで更新
3. **メモリ削除**: 付箋がアニメーションで除去
4. **メモリ編集**: 付箋のタイトルや値を編集可能

#### 視覚的フィードバック

- **リアルタイム更新**: 値変更の即座反映
- **アニメーション**: スムーズな表示・非表示
- **エラー表示**: 無効な操作時の視覚的警告
- **成功表示**: 正常な操作時の確認表示

### 参考資料

- [Java Scanner Class](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Scanner.html)
- [Java Math Class](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Math.html)
- [BigDecimal for Precise Calculations](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/math/BigDecimal.html)

### 次のステップ

- エラーハンドリングの強化
- 単体テストの作成
- フロントエンド UI との統合準備
